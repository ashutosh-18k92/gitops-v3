# Staging environment overrides for aggregator service

# Two replicas for staging
replicaCount: 2

image:
  # Use versioned staging image
  tag: "stage-v1.0.0"
  pullPolicy: IfNotPresent

# Staging resource limits (same as base)
resources:
  requests:
    memory: "128Mi"
    cpu: "100m"
  limits:
    memory: "256Mi"
    cpu: "200m"

# Staging environment variables
env:
  PORT: "3000"
  SERVICE_NAME: "aggregator"
  NODE_ENV: "staging"
  LOG_LEVEL: "info"

# Standard health checks
healthcheck:
  liveness:
    initialDelaySeconds: 10
    periodSeconds: 10
  readiness:
    initialDelaySeconds: 5
    periodSeconds: 5

# Staging VirtualService configuration
virtualService:
  enabled: true
  namespace: istio-system
  hosts:
    - aggregator-service.stage.api.local
  gateways:
    - super-fortnight-gateway
  http:
    - match:
        - uri:
            prefix: /api
      route:
        - destination:
            port:
              number: 3000
      retries:
        attempts: 3
        perTryTimeout: 2s
        retryOn: 5xx,reset,connect-failure,refused-stream
    - match:
        - uri:
            prefix: /health
      route:
        - destination:
            port:
              number: 3000
      timeout: 2s

# Standard Istio sidecar
istio:
  enabled: true
  proxyCPU: "100m"
  proxyMemory: "128Mi"
  rewriteAppHTTPProbers: "true"

podAnnotations:
  sidecar.istio.io/proxyCPU: "100m"
  sidecar.istio.io/proxyMemory: "128Mi"
  sidecar.istio.io/rewriteAppHTTPProbers: "true"

# Enable PDB for staging
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# No autoscaling in staging (fixed replicas for testing)
autoscaling:
  enabled: false
