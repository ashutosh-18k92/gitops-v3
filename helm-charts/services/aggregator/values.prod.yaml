# Production environment overrides for aggregator service

# Five replicas for high availability
replicaCount: 5

image:
  # Use immutable release tag
  tag: "v1.0.0"
  pullPolicy: IfNotPresent

# Production resource limits (increased)
resources:
  requests:
    memory: "256Mi"
    cpu: "250m"
  limits:
    memory: "512Mi"
    cpu: "500m"

# Production environment variables
env:
  PORT: "3000"
  SERVICE_NAME: "aggregator"
  NODE_ENV: "production"
  LOG_LEVEL: "warn"

# Conservative health checks for production
healthcheck:
  liveness:
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 5
  readiness:
    initialDelaySeconds: 15
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3

# Production VirtualService configuration
virtualService:
  enabled: true
  namespace: istio-system
  hosts:
    - aggregator-service.api.company.com # Production domain
  gateways:
    - super-fortnight-gateway
  http:
    - match:
        - uri:
            prefix: /api
      route:
        - destination:
            port:
              number: 3000
      retries:
        attempts: 3
        perTryTimeout: 2s
        retryOn: 5xx,reset,connect-failure,refused-stream
      timeout: 30s # Add overall timeout for production
    - match:
        - uri:
            prefix: /health
      route:
        - destination:
            port:
              number: 3000
      timeout: 2s

# Production Istio sidecar with higher resources
istio:
  enabled: true
  proxyCPU: "200m"
  proxyMemory: "256Mi"
  rewriteAppHTTPProbers: "true"

podAnnotations:
  sidecar.istio.io/proxyCPU: "200m"
  sidecar.istio.io/proxyMemory: "256Mi"
  sidecar.istio.io/rewriteAppHTTPProbers: "true"

# Enable PDB for production with majority quorum
podDisruptionBudget:
  enabled: true
  minAvailable: 3 # Maintain majority for 5 replicas

# Enable autoscaling in production
autoscaling:
  enabled: true
  minReplicas: 5
  maxReplicas: 20
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Spread pods across nodes for high availability
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - aggregator-service
          topologyKey: kubernetes.io/hostname

# Production node selector (if needed)
# nodeSelector:
#   environment: production
#   tier: application
